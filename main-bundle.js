const t=255,e=[...Array(256)].map(((e,n)=>{return((a=n/t)<.04045?a/12.92:Math.pow((a+.055)/1.055,2.4))*t;var a}));function n(t,e){const n=t[0]-e[0],a=t[1]-e[1],i=t[2]-e[2];return n<128?Math.sqrt(2*n*n+4*a*a+3*i*i):Math.sqrt(3*n*n+4*a*a+2*i*i)}function a(t,e){if(0==t.length)return[];t=[...t];const n=[...Array(t[0].value.length)].map(((t,e)=>e));function a(t){const e=n.map((()=>({min:1/0,max:-1/0})));for(const{value:a}of t)for(const t of n)e[t].min=Math.min(e[t].min,a[t]),e[t].max=Math.max(e[t].max,a[t]);return e}const i=[{objects:t,ranges:a(t)}];for(;i.length<e&&i.some((({objects:t})=>t.length>1));){var o,s,r=0;for(const t of i)for(const e of n){const{min:n,max:a}=t.ranges[e],i=a-n;r<i&&(r=i,o=t,s=e)}o.objects.sort((({value:t},{value:e})=>e[s]-t[s]));const t=o.objects.reduce(((t,{count:e})=>t+e),0);for(var h=0,l=0;h<t/2;)h+=o.objects[l].count,l++;if(h>t/2){const e=h-o.objects[l-1].count;Math.abs(e-t/2)<Math.abs(h-t/2)&&(l-=1)}const e=o.objects.splice(l),c={objects:e,ranges:a(e)};o.ranges=a(o.objects),i.push(c)}return i.map((({objects:t})=>t))}[...Array(256)].map(((e,n)=>{return((a=n/t)>.0031308?1.055*Math.pow(a,1/2.4)-.055:12.92*a)*t;var a}));class i{constructor(...t){if("number"==typeof t[0]){const[e,n]=t;this.data=new Float32Array(e*n),this.width=e,this.height=n}else if(t[0]instanceof ArrayBuffer){const[e,n]=t;this.data=new Float32Array(e),this.width=n,this.height=e.byteLength/4/n}else{const[e,a]=t,i=e.width*e.height;this.data=new Float32Array(i),this.width=e.width,this.height=e.height;for(let t=0;t<i;t++){const i=e.getPixel(t);this.data[t]=n(i,a)}}this.length=this.width*this.height,this.kind=i.kind}getDiff(t){return this.data[t]}setDiff(t,e){this.data[t]=e}}i.kind="ImageDiff";class o{constructor(...t){if("number"==typeof t[0]){const[e,n]=t;this.imageData=new ImageData(e,n)}else if(t[0]instanceof Uint8ClampedArray){const[e,n]=t;this.imageData=new ImageData(e,n)}else{const[e]=t;this.imageData=new ImageData(e.data.slice(0),e.width)}this.width=this.imageData.width,this.height=this.imageData.height,this.length=this.width*this.height,this.kind=o.kind}getPixel(t){return t*=4,[this.imageData.data[t+0],this.imageData.data[t+1],this.imageData.data[t+2],this.imageData.data[t+3]]}setPixel(t,e){t*=4,this.imageData.data[t+0]=e[0],this.imageData.data[t+1]=e[1],this.imageData.data[t+2]=e[2],this.imageData.data[t+3]=e[3]}static get[Symbol.species](){return ImageData}}function s(t,e){let a=1/0,i=0;for(let o=0;o<e.length;o++){const s=n(t,e[o]);s<a&&(a=s,i=o)}return i}o.kind="RGBAImage";class r{constructor(t,e=256){this.kind=r.kind,t=new o(t.imageData),this.width=t.width,this.height=t.height,this.length=t.length,this.data=new Uint8Array(this.length);const n=function(t){const e=new Map;for(let n=0;n<t.length;n++){const a=t.getPixel(n),i=F(a);e.has(i),e.has(i)?e.get(i).count++:e.set(i,{value:a,count:1})}return[...e.values()]}(t),i=a(n,e);this.palette=i.map((t=>function(t){var e=[0,0,0,0];for(const n of t)e=e.map(((t,e)=>t+n[e]));return e.map((e=>Math.round(e/t.length)))}(t.map((({value:t})=>t)))));for(let e=0;e<t.length;e++){const n=t.getPixel(e),a=s(n,this.palette);this.data[e]=a;const i=n.map(((t,e)=>this.palette[a][e]-t)),o=[],r=e%t.width,c=Math.floor(e/t.width);//!!
r!=t.width-1&&o.push({offset:e+1,factor:7/16}),c!=t.height-1&&(0!=r&&o.push({offset:e+t.width-1,factor:3/16}),o.push({offset:e+t.width+0,factor:5/16}),r!=t.width-1&&o.push({offset:e+t.width+1,factor:1/16}));for(let{offset:e,factor:n}of o){const a=t.getPixel(e),o=i.map((t=>-t*n));t.setPixel(e,(l=o,[(h=a)[0]+l[0],h[1]+l[1],h[2]+l[2],h[3]+l[3]]))}}var h,l}getPixel(t){const e=this.data[t];return this.palette[e]}getImageData(){const t=new ImageData(this.width,this.height);for(let e=0;e<this.length;e++){const n=this.getPixel(e);t.data[4*e+0]=n[0],t.data[4*e+1]=n[1],t.data[4*e+2]=n[2],t.data[4*e+3]=n[3]}return t}}r.kind="PaletteImage";const h="repeat-symbol";class l{constructor(){this.data=new Uint8Array(2e3),this.length=0,this.byte=0,this.bitLength=0}grow(t){const e=new Uint8Array(this.data.byteLength+t);e.set(this.data),this.data=e}write(t){for(const e of t)this.byte=(this.byte<<1)+e,this.bitLength++,8==this.bitLength&&(this.length>=this.data.byteLength&&this.grow(2e3),this.data[this.length++]=this.byte,this.byte=0,this.bitLength=0)}end(){return 0!=this.bitLength&&(this.byte=this.byte<<8-this.bitLength,this.length>=this.data.byteLength&&this.grow(1),this.data[this.length++]=this.byte),{data:this.data.slice(0,this.length),lastByteLength:this.bitLength}}}function c(t){if(0!=t.length){if(1==t.length)return{count:t[0].count,left:t[0]};{const e=[...t].sort((({count:t},{count:e})=>e-t));for(;e.length>1;){const t=e.pop(),n=e.pop();e.push({count:t.count+n.count,left:t,right:n}),e.sort((({count:t},{count:e})=>e-t))}return e[0]}}}function d(t,e=[]){if(null!=t){if("value"in t){const{value:n,index:a}=t;return[{value:n,index:a,code:e}]}{const{left:n,right:a}=t;return d(n,[...e,0]).concat(d(a,[...e,1]))}}return[]}let u;function g(t,e,n,a,i,s){const r=B(e.width,e.height);return r.context.fillStyle=s?`rgb(${s})`:"black",r.context.textAlign="left",r.context.textBaseline="alphabetic",r.context.font=i.toString(),r.context.fillText(t,n,a),new o(r.context.getImageData(0,0,r.width,r.height))}async function f(t,e,n,a,i,s,r){const h=document.querySelector("#svg-creator"),l=`<svg width="${e.width}" height="${e.height}" viewBox="0 0 ${e.width} ${e.height}" xmlns="http://www.w3.org/2000/svg">\n    <text \n      x="${n}" y="${a}"\n      fill="${r?`rgb(${r})`:"black"}"\n      font-size="${i.size}px"\n      font-weight="${i.weight}"\n      font-family="${i.family.join(", ")}"\n      alignment-baseline="alphabetic"\n      text-anchor="start"\n    >${t}</text>\n  </svg>`;h.innerHTML=l;const c=h.querySelector("svg"),d=c.querySelector("text"),g=d.getBBox().width*s;d.setAttribute("textLength",g.toString());const f=new Image(e.width,e.height);null!=u||(u=new XMLSerializer),f.src=`data:image/svg+xml;utf8,${u.serializeToString(c)}`,await f.decode();const w=B(e.width,e.height);return w.width=e.width,w.height=e.height,w.context.drawImage(f,0,0,e.width,e.height),h.innerHTML="",new o(w.context.getImageData(0,0,w.width,w.height))}class w{constructor(t,e,n){this.weight=t,this.size=e,this.family=n}toString(){return`${this.weight} ${this.size}px ${this.family.join(", ")}`}}async function m(t,e,n){var a,i;const o=null!=n?function(t,e,n){const a=document.querySelector("#svg-creator");a.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg">\n    <text \n      x="0" y="0"\n      font-size="${e.size}"\n      font-weight="${e.weight}"\n      font-family="${e.family.join(", ")}"\n      alignment-baseline="alphabetic"\n    >${t}</text>\n  </svg>`;const i=a.querySelector("svg").querySelector("text"),o=i.getBBox().width*n;i.setAttribute("textLength",o.toString());const{width:s,height:r,y:h}=i.getBBox();return a.innerHTML="",{width:s,height:r,ascent:Math.abs(h)}}(t,e,n):function(t,e){const n=B();n.context.font=e.toString();const a=n.context.measureText(t),i=null!=a.actualBoundingBoxAscent&&a.actualBoundingBoxAscent+a.actualBoundingBoxDescent;return{width:a.width,height:i,ascent:a.actualBoundingBoxAscent}}(t,e),s={width:o.width+6,height:(null!==(a=o.height)&&void 0!==a?a:1.1*e.size)+6},r=Math.ceil(null!==(i=o.ascent)&&void 0!==i?i:.82*e.size),h=null!=n?await f(t,s,0,r,e,n):g(t,s,0,r,e),{top:l=r,bottom:c=r}=function(t){const e=t.width*t.height-1;let n,a,i=0;for(;null==n&&(0!=t.getPixel(i)[3]&&(n=Math.floor(i/t.width)),i++,!(i>e)););for(i=e;null==a&&(0!=t.getPixel(i)[3]&&(a=Math.ceil(i/t.width)),i--,!(i<0)););return{top:n,bottom:a}}(h),{left:d=0,right:u=0}=function(t){const e=t.width*t.height-1;let n,a,i=0;for(;null==n&&(0!=t.getPixel(i)[3]&&(n=i%t.width),i+=t.width,!(i>e&&(i=(i+1)%t.width,0==i))););for(i=e;null==a&&(0!=t.getPixel(i)[3]&&(a=i%t.width+1),i-=t.width,!(i<0&&(i+=e,i==e-t.width))););return{left:n,right:a}}(h),w=r-l,m=c-r;return{ascent:w,descent:m,height:w+m,left:d,right:u,width:u-d}}async function p(t,e,n){var a=0,i=0,o=0,s=0;const r=[];for(const h of t){const{ascent:t,descent:l,height:c,left:d,right:u,width:g}=await m(h,e,n);a=Math.max(a,t),i=Math.max(i,l),o=Math.max(o,c),s=Math.max(s,g),r.push({ascent:t,descent:l,height:c,left:d,right:u,width:g})}return 0==o&&(o=e.size,a=e.size,i=0),0==s&&(s=.9*e.size),{metrics:r,maxAscent:a,maxDescent:i,maxHeight:o,maxWidth:s}}class x{constructor(t,e){this.kind=e,this.width=t.width,this.height=t.height,this.length=t.length}}class v extends x{constructor(t){super(t,v.kind),this.data=new DataView(new ArrayBuffer(5*this.length));var e=0;for(let n=0;n<this.length;n++){const a=t.getPixel(n)[3];0!=a&&(this.data.setUint32(5*e+0,n),this.data.setUint8(5*e+4,a),e++)}this.data=new DataView(this.data.buffer.slice(0,5*e))}*[Symbol.iterator](){for(let t=0;t<this.data.byteLength/5;t++){const e=this.data.getUint32(5*t+0),n=this.data.getUint8(5*t+4),a=[0,0,0,n];0!=n&&(yield{offset:e,color:a})}}}v.kind="AlphaBitmap";class y extends x{constructor(t){super(t,y.kind),this.data=new DataView(new ArrayBuffer(8*this.length));var e=0;for(let n=0;n<this.length;n++){const a=t.getPixel(n);0!=a[3]&&(this.data.setUint32(8*e,n),this.data.setUint8(8*e+4,a[0]),this.data.setUint8(8*e+5,a[1]),this.data.setUint8(8*e+6,a[2]),this.data.setUint8(8*e+7,a[3]),e++)}this.data=new DataView(this.data.buffer.slice(0,8*e))}*[Symbol.iterator](){for(let t=0;t<this.data.byteLength/8;t++){const e=this.data.getUint32(8*t),n=this.data.getUint8(8*t+4),a=this.data.getUint8(8*t+5),i=this.data.getUint8(8*t+6),o=this.data.getUint8(8*t+7),s=[n,a,i,o];0!=o&&(yield{offset:e,color:s})}}}function b(t,e,n,a){var i=t.findIndex((t=>t.value==e));-1==i?(t.push({value:e,count:1}),i=t.length-1):t[i].count++,n.setUint16(a,i)}y.kind="ColorBitmap";class L extends x{constructor(t){super(t,L.kind),this.data=new DataView(new ArrayBuffer(4*this.length));const e=[{value:F([0,0,0,0]),count:0}],n=[{value:1,count:0}];var a,i=0,o=0;for(let s=0;s<this.length;s++){const r=F(t.getPixel(s));i++,null!=a&&a!=r&&(b(e,a,this.data,o),o+=2,b(n,i,this.data,o),o+=2,i=0),a=r}b(e,a,this.data,o),o+=2,b(n,i,this.data,o),o+=2,this.data=new DataView(this.data.buffer.slice(0,o)),this.colors=e.map((({value:t,count:e},n)=>({value:P(t),count:e,index:n}))),this.lengths=n}*[Symbol.iterator](){var t=0;for(let e=0;e<this.data.byteLength/4;e++){const n=this.data.getUint16(4*e+0),a=this.colors[n].value,i=this.data.getUint16(4*e+2),o=this.lengths[i].value;if(0!=a[3])for(let e=0;e<o;e++)yield{offset:t,color:a},t++;else t+=o}}reduceColors(t){const e=[...Array(this.colors.length)],n=[...this.colors];n[0].count>0&&(e[0]=n.shift(),t-=1);const i=a(n,t);for(const t of i){var o=[0,0,0,0];for(const{value:e}of t)o=o.map(((t,n)=>t+e[n]));o=o.map((e=>Math.round(e/t.length)));for(const{index:n}of t)e[n]=o}const s=new DataView(new ArrayBuffer(this.data.byteLength)),r=[],h=[{value:1,count:0}];var l,c=0,d=0;const u=this.data.byteLength/4;for(let t=0;t<u;t++){const n=F(e[this.data.getUint16(4*t+0)]),a=this.data.getUint16(4*t+2),i=this.lengths[a].value;null!=l&&l!=n?(b(r,l,s,d),b(h,c,s,d+=2),d+=2,c=i):c+=i,l=n}b(r,l,s,d),b(h,c,s,d+=2),d+=2,this.data=new DataView(s.buffer.slice(0,d)),this.colors=r.map((({value:t,count:e},n)=>({value:P(t),count:e,index:n}))),this.lengths=h}}L.kind="PaletteBitmap";class U extends x{constructor(t){super(t,U.kind);const e=new L(t);e.reduceColors(16);//!!!
const n=e.lengths.map((({value:t,count:e},n)=>({value:t,count:e,index:n}))),{data:a,lastByteLength:i,literalTree:o,lengthTree:s}=function(t){var e,n;const a=[...t.literals],i=t.lengths.filter((({value:t})=>1!=t)).map((({value:t,count:e},n)=>({value:t-1,count:e,index:n}))),o=i.reduce(((t,{count:e})=>t+e),0);o>0&&a.push({value:h,count:o,index:a.length});const s=c(a),r=c(i),u=d(s).sort((({index:t},{index:e})=>t-e)),g=d(r).sort((({index:t},{index:e})=>t-e)),f=null===(e=u.find((({value:t})=>t==h)))||void 0===e?void 0:e.code,w=new l;for(let e=0;e<t.data.byteLength/4;e++){const a=t.data.getUint16(4*e+0),i=t.data.getUint16(4*e+2),o=null===(n=g[i-1])||void 0===n?void 0:n.value;w.write(u[a].code),o>0&&(w.write(f),w.write(g[i-1].code))}const{data:m,lastByteLength:p}=w.end();return{data:m,lastByteLength:p,literalTree:s,lengthTree:r}}({data:e.data,literals:e.colors,lengths:n});this.data=a,this.lastByteLength=i,this.literalTree=o,this.lengthTree=s}*[Symbol.iterator](){var t,e=!1,n=0;for(const a of function*(t,e,n,a){for(var i,o=n,s=a,r=0,l=0,c=!1;r<t.byteLength-1||r==t.byteLength-1&&l<e;){0==l&&(i=t[r]);const e=i&1<<7-l++;let d;if(c){const t=0==e?null==s?void 0:s.left:null==s?void 0:s.right;"value"in t?(d=t.value,s=a):s=t}else{const t=0==e?null==o?void 0:o.left:null==o?void 0:o.right;"value"in t?(d=t.value,o=n):o=t}null!=d&&(c=d==h,yield d),l>7&&(r++,l=0)}}(this.data,this.lastByteLength,this.literalTree,this.lengthTree))if(a!=h){e||(t=a);const i=e?a:1;if(0!=t[3])for(let e=0;e<i;e++)yield{offset:n,color:t},n++;else n+=i;e=!1}else e=!0}}U.kind="CompressedBitmap";const D=[191.25,191.25,191.25];async function M(t,e,n=400){if("uris"in t);else if(!("aspectRatio"in t)){const a=await async function(t,e,n,a){const i=[];for(const e of t.texts){const t=e.text.trim();i.push(t),e.text=t}const o=e/(1+t.padding.y),s=new w(n,o,t.fontFamily);await document.fonts.load(s.toString(),i.join(""));const r="alignBaseline"in t&&t.alignBaseline,h="textLength"in t?t.textLength:void 0,l=await p(i,s,h),c=r?l.maxAscent+l.maxDescent:l.maxHeight,d=new w(n,o*(o/c),t.fontFamily),u=await p(i,d,h),m=r?u.maxAscent+u.maxDescent:u.maxHeight,x=m*(1+t.padding.y),v={width:Math.floor(u.maxWidth*(1+t.padding.x(e))),height:Math.floor(e>30&&e<x?e:x)},y=[];for(let e=0;e<t.texts.length;e++){const n=t.texts[e],i=u.metrics[e],o=v.width/2-i.width/2-i.left,s=n.text,l="color"in n?n.color:a;var b;if(r)b=u.maxAscent+(v.height-m)/2;else{const{ascent:t,height:e}=i;b=t+(v.height-e)/2}const c=null!=h?await f(s,v,o,b,d,h,l):g(s,v,o,b,d,l);y.push(c)}return y}(t,e,n,D);return"color"in t.texts[0]?a.map((t=>new y(t))):a.map((t=>new v(t)))}}function A(t,e){const n=[];let{start:a,length:i}=t;const o=i/e;for(0!==o&&!Number.isNaN(o)&&Number.isFinite(o)||(i=0);i>0&&e>=1;){let t=e>1?Math.ceil(i/e):i;n.push({start:a,length:t}),i-=t,a+=t,e--,i<1&&i>0&&(e=1)}return n}function S(t,e=1){return 0==t?0:t**e}function B(t=0,e=0){const n=document.createElement("canvas");n.width=t,n.height=e;const a=n.getContext("2d");return Object.assign(n,{context:a})}function k(t){const e=t.getClientRects()[0];return{width:e.width*devicePixelRatio,height:e.height*devicePixelRatio}}function F(t){return t[0]<<24|t[1]<<16|t[2]<<8|t[3]}function P(t){return[(4278190080&t)>>>24,(16711680&t)>>>16,(65280&t)>>>8,(255&t)>>>0]}function T(t,e,n,a,i){var o=0;for(let s=0;s<a.height;s++)for(let r=0;r<a.width;r++){const h=a.offset.left+r*a.cell.width,l=a.offset.top+s*a.cell.height;for(let s=0;s<a.cell.height;s++){const r=4*(h+(s+l)*n),c=4*a.cell.width;if("flatten"==i){const n=new Uint8Array(t.buffer,r,c);e.set(n,o)}else if("unflatten"==i){const n=new Uint8Array(e.buffer,o,c);t.set(n,r)}o+=c}}}function I(t,e,n){const a=new Uint8Array(t.buffer),i=new Uint8Array(n.cell.width*n.cell.height*n.length*4);return T(a,i,e,n,"flatten"),i}function C(t,e){return new ImageData(new Uint8ClampedArray(I(t.data,t.width,e).buffer),e.cell.width)}function q(t,e,n,a){T(new Uint8Array(t.buffer),new Uint8Array(e.buffer),n,a,"unflatten")}function $(t,e,n){q(t.data,e.data,t.width,n)}class E extends Worker{constructor(){super("./worker-bundle.js")}async calc(t,e){return this.callFunction("calc",t,e)}async calcPalette(t,e){return this.callFunction("calcPalette",t,e)}callFunction(t,e,n){var a,i=!1,o=!1;return function t(){o&&(n(a),o=!1),i||requestAnimationFrame(t)}(),function(t,e,n,a){const i=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16);return t.postMessage({name:e,id:i,message:n}),new Promise((e=>{t.addEventListener("message",(function n({data:o}){o&&o.id==i&&(o.message.done?(t.removeEventListener("message",n),a({value:o.message.value,done:!0}),e(o.message.value)):a({value:o.message.value,done:!1}))}))}))}(this,t,e,(function(t){t.done?i=!0:(o=!0,a=t.value)}))}}const j={texts:[{text:"0"},{text:"1"},{text:"2"},{text:"3"},{text:"4"},{text:"5"},{text:"6"},{text:"7"},{text:"8"},{text:"9"}],smallestSize:6,fontFace:new FontFace("Work Sans","url(./QGYsz_wNahGAdqQ43Rh_fKDp.woff2) format('woff2')",{style:"normal",weight:"100 1000",display:"swap",unicodeRange:"U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD"}),fontFamily:["'Work Sans'","Arial","san-serif"],fontWeight:{min:400,max:600,factor:20},padding:{x:t=>{const e=(15-t)/(15-j.smallestSize);return t<15?-.3*e+-.05*(1-e):-.05},y:.02}},z={title:"",imageSource:"",alphabet:j,backgroundColor:[255,255,255],animation:!0,epilogue:{text:"",duration:5e3}},R=navigator.hardwareConcurrency-1||1;let W=[];const O=Symbol("idle");async function*H(t,e,n){var a=t.slice(0,e.length).map(((t,e)=>Promise.resolve({worker:t,index:e,result:O})));for(const t of e){const{result:e,worker:i,index:o}=await Promise.race([...a,n]);a[o]=t(i).then((t=>({result:t,worker:i,index:o}))),e!=O&&(yield e)}const i=a;for(;i.some((t=>null!=t));){const{result:t,index:e}=await Promise.race([...i.filter((t=>null!=t)),n]);i[e]=void 0,yield t}}class V extends Promise{constructor(t){var e;super(((t,n)=>{e=()=>n(new Error("aborted"))})),this.abort=e,t&&(t.aborted?this.abort():t.addEventListener("abort",this.abort))}}V.prototype.constructor=Promise;const N=[];function G(t,n){return async function(){await async function(t){for(const e of t)if(e.started&&!e.stopped&&!e.ended){e.stop(),await e.promise;break}}(n),t.started?(t.stopped||t.ended)&&(t.element.classList.remove("stopped"),t.bigStop.classList.remove("fade-out"),setTimeout((()=>t.bigRestart.classList.remove("fade-out")),1e3),t.stopped=!1,t.ended=!1):t.element.classList.add("started"),t.canvas.context||(t.canvas=Object.assign(t.canvas,{context:t.canvas.getContext("2d",{alpha:!0})})),t.abortController=new AbortController,t.promise=async function(t,n,a){const{alphabet:s,imageSource:r}=n;"fontFace"in s&&s.fontFace instanceof FontFace&&(s.fontFace.load(),document.fonts.add(s.fontFace));const h=k(t.canvas),l=await fetch(r).then((t=>t.blob())),c=await async function(t,e,n){const a=document.createElement("img");a.decoding="async",a.src=URL.createObjectURL(t),await new Promise((t=>a.addEventListener("load",t)));const{width:i,height:o}=function(t,e){const n=Math.min(e.width/t.width,e.height/t.height);return{width:t.width*n,height:t.height*n}}(n,e),s=B(i,o);return s.context.drawImage(a,0,0,s.width,s.height),URL.revokeObjectURL(a.src),s.context.getImageData(0,0,s.width,s.height)}(l,h,t.rect),d=function(t){const e=document.createElement("canvas");e.width=t.width,e.height=t.height;const n=e.getContext("2d");return n.putImageData(t,0,0),Object.assign(e,{context:n})}(c);t.canvas.width=c.width,t.canvas.height=c.height;const u=function(t){const n=new Uint8ClampedArray(t.data.length);for(let a=0;a<t.data.byteLength;a+=4)n[a+0]=e[t.data[a+0]],n[a+1]=e[t.data[a+1]],n[a+2]=e[t.data[a+2]],n[a+3]=t.data[a+3];return new ImageData(n,t.width)}(new o(c).imageData);0===W.length&&(W=[...Array(R)].map((()=>new E)));const g=new V(a);await async function(t,e,n,a){var s,r,h;const{alphabet:l,animation:c,backgroundColor:d}=n;let u;n.palette instanceof Array?u=n.palette:n.palette;const g=new ImageData(t.width,t.height),f=new i(new o(e),d);for(let n of function*(t,e){const n=Math.floor(Math.log2(t/e));for(let i=0;i<=n;i++){const o=(a=i/n)<.5?S(2*a,20)/2:1-S(2-2*a,20)/2;yield Math.floor((1-o)*t/2**i+o*e*2**(n-i))}var a}(t.height,l.smallestSize)){let d;if("fontWeight"in l){const e=S(Math.log2(t.height/n)/Math.log2(t.height/l.smallestSize),l.fontWeight.factor),a=(null===(s=l.fontWeight)||void 0===s?void 0:s.min)||400,i=(null===(r=l.fontWeight)||void 0===r?void 0:r.max)-(null===(h=l.fontWeight)||void 0===h?void 0:h.min)||200;d=Math.round(a+i*e)}const w=await Promise.race([M(l,n,d),a]);n=w[0].height;const m=w[0].width;if(m>t.width)continue;const p=Math.max(1,Math.floor(t.width/m)),x=Math.max(Math.floor(t.height/n)),v={width:p,height:x,length:p*x,offset:{left:Math.floor(t.width%m/2),top:Math.floor(t.height%n/2)},cell:{width:m,height:n,length:m*n}},y=C(e,v),b=C(g,v),L=new i(I(f.data,f.width,v).buffer,v.cell.width),U=[];//!!
for(let{start:e,length:n}of A({start:0,length:v.length},R))U.push((async a=>{e*=v.cell.length;const s=e+n*v.cell.length,r={original:new o(y.data.slice(4*e,4*s),v.cell.width),image:new o(b.data.slice(4*e,4*s),v.cell.width),imageDiff:new i(L.data.slice(e,s).buffer,v.cell.width)};function h(n){b.data.set(n.data,4*e),$(g,b,v),t.context.putImageData(g,0,0)}let l;return l=u?await a.calcPalette({data:r,gridLength:n,cellLength:v.cell.length,bitmaps:w,animation:c,palette:u},h):await a.calc({data:r,gridLength:n,cellLength:v.cell.length,bitmaps:w,animation:c},h),{result:l,start:e}}));for await(const{result:e,start:n}of H(W,U,a))b.data.set(e.image.data,4*n),L.data.set(e.imageDiff.data,n),$(g,b,v),t.context.putImageData(g,0,0),await new Promise((t=>setTimeout(t,0)));q(f.data,L.data,f.width,v)}}(t.canvas,u,n,g),function(t,e,n="source-over"){const a=t.getContext("2d"),i=a.globalCompositeOperation;a.globalCompositeOperation=n,a.drawImage(e,0,0),a.globalCompositeOperation=i}(t.canvas,d,"destination-over")}(t,t.frame,t.abortController.signal).then((()=>{t.ended=!0,t.element.classList.add("stopped")})).catch((()=>{t.stopped=!0,t.element.classList.add("stopped")})).finally((()=>{!t.stopped&&t.repeat&&t.play(),t.endTime=performance.now(),clearInterval(t.intervalId),t.setTimer()})),t.started=!0,t.startTime=performance.now(),t.endTime=null,t.intervalId=setInterval((()=>t.setTimer()),100)}}function _(t){return function(){!function(){for(let t of W)t.terminate();W=[]}(),t.abortController.abort()}}function Q(t){return function(){const e=((t.endTime||performance.now())-t.startTime)/1e3;t.timerText.innerHTML=`${e.toFixed(3)}s`}}function X(t){return function(){t.element.classList.toggle("repeat"),t.repeat=!t.repeat}}function K(t){let e=!1;return t.element.addEventListener("fullscreenchange",(function(){e=!e})),function(){!1===e?t.element.requestFullscreen():document.exitFullscreen()}}document.addEventListener("DOMContentLoaded",(function(){const t=Array.from(document.querySelectorAll(".player"));for(const e of t){const t=e.querySelector("canvas"),n=e.querySelector(".preview"),a=e.querySelector(".big-play-button"),i=e.querySelector(".big-stop"),o=e.querySelector(".big-restart"),s=e.querySelector(".play-button"),r=e.querySelector(".stop-button"),h=e.querySelector(".restart-button"),l=e.querySelector(".timer-text"),c=e.querySelector(".resolution-text"),d=e.querySelector(".repeat-button"),u=e.querySelector(".fullscreen-button"),g={frame:{...z,imageSource:e.dataset.url},started:!1,stopped:!1,ended:!1,repeat:!1,element:e,rect:k(e),canvas:t,preview:n,bigPlayButton:a,bigStop:i,bigRestart:o,playButton:s,stopButton:r,restartButton:h,timerText:l,resolutionText:c,repeatButton:d,fullscreenButton:u};g.play=G(g,N),g.stop=_(g),g.setTimer=Q(g),n.addEventListener("click",g.play),t.addEventListener("click",(function(){g.stopped||g.ended?(g.bigRestart.classList.add("fade-out"),g.play()):(g.bigStop.classList.add("fade-out"),g.stop())})),new MutationObserver((()=>{g.resolutionText.innerHTML=`${t.width}x${t.height}px`})).observe(t,{attributes:!0,attributeFilter:["width","height"]}),a.addEventListener("click",g.play),s.addEventListener("click",g.play),r.addEventListener("click",g.stop),h.addEventListener("click",g.play),d.addEventListener("click",X(g)),u.addEventListener("click",K(g)),N.push(g)}}));
